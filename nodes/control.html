<!--
Copyright (c) 2021 Jens-Uwe Rossbach

This code is licensed under the MIT License.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->

<script type="text/x-red" data-template-name="sony-audio-control">
    <style>
        .form-checkbox-row
        {
            float:        left;
            padding-left: 4px;
        }

        .form-checkbox-label
        {
            padding-left: 10px;
        }

        input[type=checkbox].form-checkbox
        {
            vertical-align: text-bottom;
            float:          left;
            width:          auto;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red-contrib-sony-audio/sony-audio-device:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-cog"></i> <span data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.device"></span></label>
        <input type="text" id="node-input-device" data-i18n="[placeholder]node-red-contrib-sony-audio/sony-audio-device:common.label.device">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]node-red-contrib-sony-audio/sony-audio-device:common.label.topic">
    </div>
    <div class="form-row">
        <label style="float: left;"><i class="fa fa-download"></i> <span data-i18n="control.label.input"></span></label>
        <div class="form-checkbox-row">
            <div>
                <input type="checkbox" class="form-checkbox" id="node-input-enableTopic">
                <label class="form-checkbox-label" style="width: auto;" for="node-input-enableTopic" data-i18n="control.label.enableTopic"></label>
            </div>
            <div>
                <input type="checkbox" class="form-checkbox" id="node-input-enableLowLevel">
                <label class="form-checkbox-label" style="width: auto;" for="node-input-enableLowLevel" data-i18n="control.label.enableLowLevel"></label>
            </div>
        </div>
    </div>
    <div class="form-row">
        <label style="float: left;"><i class="fa fa-upload"></i> <span data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.outputs"></span></label>
        <div class="form-checkbox-row">
            <div>
                <input type="checkbox" class="form-checkbox" id="node-input-outFilters">
                <label class="form-checkbox-label" style="width: auto;" for="node-input-outFilters" data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.filters"></label>
            </div>
            <div>
                <input type="checkbox" class="form-checkbox" id="node-input-outResponse">
                <label class="form-checkbox-label" style="width: auto;" for="node-input-outResponse" data-i18n="control.label.response"></label>
            </div>
        </div>
    </div>
    <div class="form-row"></div>
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-exchange"></i> <span data-i18n="control.label.command"></span></label>
        <select id="node-input-command" style="width: auto;">
            <optgroup data-i18n="[label]node-red-contrib-sony-audio/sony-audio-device:common.list.service.system">
                <option value="getPowerStatus" data-i18n="control.list.command.getPowerStatus"></option>
                <option value="powerOn" data-i18n="control.list.command.powerOn"></option>
                <option value="powerOff" data-i18n="control.list.command.powerOff"></option>
                <option value="standBy" data-i18n="control.list.command.standBy"></option>
                <option value="getSWUpdateInfo" data-i18n="control.list.command.getSWUpdateInfo"></option>
                <option value="reconnect" data-i18n="control.list.command.reconnect"></option>
            </optgroup>
            <optgroup data-i18n="[label]node-red-contrib-sony-audio/sony-audio-device:common.list.service.audio">
                <option value="getVolumeInfo" data-i18n="control.list.command.getVolumeInfo"></option>
                <option value="setVolume" data-i18n="control.list.command.setVolume"></option>
                <option value="mute" data-i18n="control.list.command.mute"></option>
                <option value="unmute" data-i18n="control.list.command.unmute"></option>
                <option value="toggleMute" data-i18n="control.list.command.toggleMute"></option>
                <option value="getSoundSettings" data-i18n="control.list.command.getSoundSettings"></option>
                <option value="setSoundSettings" data-i18n="control.list.command.setSoundSettings"></option>
                <option value="getSpeakerSettings" data-i18n="control.list.command.getSpeakerSettings"></option>
                <option value="setSpeakerSettings" data-i18n="control.list.command.setSpeakerSettings"></option>
            </optgroup>
            <optgroup data-i18n="[label]node-red-contrib-sony-audio/sony-audio-device:common.list.service.avContent">
                <option value="getSource" data-i18n="control.list.command.getSource"></option>
                <option value="setSource" data-i18n="control.list.command.setSource"></option>
                <option value="getPlaybackSettings" data-i18n="control.list.command.getPlaybackSettings"></option>
                <option value="setPlaybackSettings" data-i18n="control.list.command.setPlaybackSettings"></option>
                <option value="stop" data-i18n="control.list.command.stop"></option>
                <option value="togglePause" data-i18n="control.list.command.togglePause"></option>
                <option value="skipPrev" data-i18n="control.list.command.skipPrev"></option>
                <option value="skipNext" data-i18n="control.list.command.skipNext"></option>
                <option value="scanBackward" data-i18n="control.list.command.scanBackward"></option>
                <option value="scanForward" data-i18n="control.list.command.scanForward"></option>
            </optgroup>
        </select>
    </div>
    <div id="form-row-swupdate" class="form-row">
        <label><i class="fa fa-sign-in"></i> <span data-i18n="control.label.swSource"></span></label>
        <span>
            <input id="node-input-networkUpdate" type="checkbox" style="vertical-align: text-bottom; width: auto;">
            <label for="node-input-networkUpdate" style="width: auto;" data-i18n="control.label.networkUpdate"></label>
        </span>
    </div>
    <div id="form-row-volume" class="form-row">
        <label for="node-input-volume"><i class="fa fa-volume-up"></i> <span data-i18n="control.label.volume"></span></label>
        <input id="node-input-volume" style="width: 60px !important; float: left;" value="1">
        <span style="padding-left: 10px;">
            <input id="node-input-relativeVolume" type="checkbox" style="vertical-align: text-bottom; width: auto;">
            <label for="node-input-relativeVolume" style="width: auto;" data-i18n="control.label.relativeVolume"></label>
        </span>
    </div>
    <div id="form-row-source" class="form-row">
        <label for="node-input-source"><i class="fa fa-sign-in"></i> <span data-i18n="control.label.audioSource"></span></label>
        <select id="node-input-source" style="width: auto;">
            <option value="extInput:tv" data-i18n="control.list.source.tv"></option>
            <option value="extInput:sat-catv" data-i18n="control.list.source.satcatv"></option>
            <option value="extInput:hdmi" data-i18n="control.list.source.hdmi"></option>
            <option value="extInput:video" data-i18n="control.list.source.video"></option>
            <option value="extInput:sacd-cd" data-i18n="control.list.source.sacdcd"></option>
            <option value="extInput:bd-dvd" data-i18n="control.list.source.bddvd"></option>
            <option value="storage:usb1" data-i18n="control.list.source.usb"></option>
            <option value="extInput:line" data-i18n="control.list.source.line"></option>
            <option value="extInput:btAudio" data-i18n="control.list.source.bt"></option>
            <option value="dlna:music" data-i18n="control.list.source.dlna"></option>
            <option value="radio:fm" data-i18n="control.list.source.fm"></option>
            <option value="extInput:game" data-i18n="control.list.source.game"></option>
            <option value="extInput:source" data-i18n="control.list.source.source"></option>
        </select>
    </div>
    <div id="form-row-port" class="form-row">
        <label for="node-input-port"><i class="fa fa-bookmark"></i> <span data-i18n="control.label.port"></span></label>
        <input id="node-input-port" style="width: 60px !important;" value="1">
    </div>
    <div id="form-row-preset" class="form-row">
        <label for="node-input-preset"><i class="fa fa-bookmark"></i> <span data-i18n="control.label.preset"></span></label>
        <input id="node-input-preset" style="width: 60px !important;" value="0">
    </div>
    <div id="form-row-zone" class="form-row">
        <label for="node-input-zone"><i class="fa fa-sign-out"></i> <span data-i18n="control.label.zone"></span></label>
        <input id="node-input-zone" style="width: 60px !important;" value="1">
        <span style="padding-left: 10px;">
            <input id="node-input-allzones" type="checkbox" style="vertical-align: text-bottom; width: auto;">
            <label for="node-input-allzones" style="width: auto;" data-i18n="control.label.allZones"></label>
        </span>
    </div>
    <div id="form-row-soundSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.settings"></span></label>
        <div class="form-row">
            <ol id="node-input-soundSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-soundTarget" class="form-row">
        <label for="node-input-soundTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.setting"></span></label>
        <select id="node-input-soundTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.soundTarget.all"></option>
            <option value="soundField" data-i18n="control.list.soundTarget.soundField"></option>
            <option value="clearAudio" data-i18n="control.list.soundTarget.clearAudio"></option>
            <option value="nightMode" data-i18n="control.list.soundTarget.nightMode"></option>
            <option value="footballMode" data-i18n="control.list.soundTarget.footballMode"></option>
            <option value="voice" data-i18n="control.list.soundTarget.voice"></option>
        </select>
    </div>
    <div id="form-row-speakerSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.settings"></span></label>
        <div class="form-row">
            <ol id="node-input-speakerSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-speakerTarget" class="form-row">
        <label for="node-input-speakerTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.setting"></span></label>
        <select id="node-input-speakerTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.speakerTarget.all"></option>
            <option value="inCeilingSpeakerMode" data-i18n="control.list.speakerTarget.inCeilingSpeakerMode"></option>
            <option value="speakerSelection" data-i18n="control.list.speakerTarget.speakerSelection"></option>
            <option value="frontLLevel" data-i18n="control.list.speakerTarget.frontLLevel"></option>
            <option value="frontRLevel" data-i18n="control.list.speakerTarget.frontRLevel"></option>
            <option value="centerLevel" data-i18n="control.list.speakerTarget.centerLevel"></option>
            <option value="surroundLLevel" data-i18n="control.list.speakerTarget.surroundLLevel"></option>
            <option value="surroundRLevel" data-i18n="control.list.speakerTarget.surroundRLevel"></option>
            <option value="surroundcBackLevel" data-i18n="control.list.speakerTarget.surroundcBackLevel"></option>
            <option value="surroundBackLLevel" data-i18n="control.list.speakerTarget.surroundBackLLevel"></option>
            <option value="surroundBackRLevel" data-i18n="control.list.speakerTarget.surroundBackRLevel"></option>
            <option value="heightLLevel" data-i18n="control.list.speakerTarget.heightLLevel"></option>
            <option value="heightRLevel" data-i18n="control.list.speakerTarget.heightRLevel"></option>
            <option value="subwooferLevel" data-i18n="control.list.speakerTarget.subwooferLevel"></option>
        </select>
    </div>
    <div id="form-row-modeSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.modes"></span></label>
        <div class="form-row">
            <ol id="node-input-modeSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-modeTarget" class="form-row">
        <label for="node-input-modeTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.mode"></span></label>
        <select id="node-input-modeTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.modeTarget.all"></option>
            <option value="playType" data-i18n="control.list.modeTarget.playType"></option>
            <option value="repeatType" data-i18n="control.list.modeTarget.repeatType"></option>
            <option value="shuffleType" data-i18n="control.list.modeTarget.shuffleType"></option>
        </select>
    </div>
    <div id="form-row-filterList" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-filter"></i> <span data-i18n="node-red-contrib-sony-audio/sony-audio-device:common.label.filters"></span></label>
        <div class="form-row">
            <ol id="node-input-filterList"></ol>
        </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("sony-audio-control",
    {
        category:     "sony audio",
        color:        "#2DABCE",
        icon:         "sony.png",
        inputs:       1,
        outputs:      1,
        inputLabels:  function()
        {
            return this._("control.label.inputPort");
        },
        paletteLabel: "control",
        label: function()
        {
            return (this.name || "control: " + this.command);
        },
        labelStyle: function()
        {
            return (this.name ? "node_label_italic" : "");
        },
        outputLabels: function(index)
        {
            return this.outputPorts[index].label;
        },
        defaults:
        {
            name:
            {
                value: ""
            },
            device:
            {
                value: "",
                type:  "sony-audio-device"
            },
            topic:
            {
                value: ""
            },
            outputs:
            {
                value: 1
            },
            outputPorts:
            {
                value: [{label: "", filter: {name: "auto"}}]
            },
            outFilters:
            {
                value: true
            },
            outResponse:
            {
                value: false
            },
            enableTopic:
            {
                value: false
            },
            enableLowLevel:
            {
                value: false
            },
            command:
            {
                value: "powerOn"
            },
            networkUpdate:
            {
                value: true
            },
            volume:
            {
                value: "1"
            },
            relativeVolume:
            {
                value: false
            },
            source:
            {
                value: "extInput:tv"
            },
            port:
            {
                value: "1"
            },
            preset:
            {
                value: "0"
            },
            zone:
            {
                value: "0"
            },
            soundSettings:
            {
                value: [{target: "soundField", value: "clearAudio"}]
            },
            soundTarget:
            {
                value: "soundField"
            },
            speakerSettings:
            {
                value: [{target: "inCeilingSpeakerMode", value: "off"}]
            },
            speakerTarget:
            {
                value: "inCeilingSpeakerMode"
            },
            modeSettings:
            {
                value: [{target: "playType", value: "normal"}]
            },
            modeTarget:
            {
                value: "playType"
            }
        },
        oneditprepare: function()
        {
            let node = this;
            let commandSelect = $("#node-input-command");
            let sourceSelect = $("#node-input-source");
            let relativeVol = $("#node-input-relativeVolume");
            let allZones = $("#node-input-allzones");
            let outFiltersSelect = $("#node-input-outFilters");

            // backward compatibility
            if (node.command == "setPlaybackModes") { commandSelect.val("setPlaybackSettings"); }
            if (node.command == "getPlaybackModes") { commandSelect.val("getPlaybackSettings"); }
            if (typeof node.enableLowLevel == "undefined") { $("#node-input-enableLowLevel").prop("checked", true); }
            if (typeof node.preset == "undefined") { $("#node-input-preset").val(0); }
            if (typeof node.speakerSettings == "undefined") { node.speakerSettings = [{target: "inCeilingSpeakerMode", value: "off"}]; }
            if (typeof node.speakerTarget == "undefined") { $("#node-input-speakerTarget").val("inCeilingSpeakerMode"); }

            const validateVolume = function(event, ui)
            {
                let value = parseInt($(this).spinner("value"), 10);
                let min = $(this).spinner("option", "min");
                let max = $(this).spinner("option", "max");

                if (isNaN(value) || (value < min))
                {
                    $(this).spinner("value", min);
                }
                else if (value > max)
                {
                    $(this).spinner("value", max);
                }

                if ((min < 0) && (value == 0))
                {
                    $(this).spinner("value", 1);
                }
            };

            const validateZonePortPreset = function(event, ui)
            {
                let value = parseInt($(this).spinner("value"), 10);
                let min = $(this).spinner("option", "min");
                let max = $(this).spinner("option", "max");

                if (isNaN(value) || (value < min))
                {
                    $(this).spinner("value", min);
                }
                else if (value > max)
                {
                    $(this).spinner("value", max);
                }
            };

            let volSpinner = $("#node-input-volume").spinner(
            {
                min: 0,
                max: 99,
                step: 1,
                numberFormat: "n",
                change: validateVolume
            });

            let portSpinner = $("#node-input-port").spinner(
            {
                min: 1,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            let presetSpinner = $("#node-input-preset").spinner(
            {
                min: 0,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            let zoneSpinner = $("#node-input-zone").spinner(
            {
                min: 1,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            let soundSettingsList = $("#node-input-soundSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                addItem: function(item, index, soundSetting)
                {
                    if (!("target" in soundSetting))
                    {
                        soundSetting.target = "soundField";
                        soundSetting.value = "off";
                    }

                    let soundTarget = $("<select/>", {class: "node-input-soundTarget"}).appendTo(item);
                    soundTarget.append($("<option></option>").val("soundField").text(node._("control.list.soundTarget.soundField")));
                    soundTarget.append($("<option></option>").val("clearAudio").text(node._("control.list.soundTarget.clearAudio")));
                    soundTarget.append($("<option></option>").val("nightMode").text(node._("control.list.soundTarget.nightMode")));
                    soundTarget.append($("<option></option>").val("footballMode").text(node._("control.list.soundTarget.footballMode")));
                    soundTarget.append($("<option></option>").val("voice").text(node._("control.list.soundTarget.voice")));

                    let soundFieldContainer = $("<span/>", {id: "item-elem-soundField-" + index,
                                                            style: "padding-left: 10px;"}).appendTo(item);
                    let soundField = $("<select/>", {class: "node-input-soundField",
                                                     style: "width: auto;"}).appendTo(soundFieldContainer);
                    soundField.append($("<option></option>").val("off").text(node._("control.list.soundField.off")));
                    soundField.append($("<option></option>").val("standard").text(node._("control.list.soundField.standard")));
                    soundField.append($("<option></option>").val("clearAudio").text(node._("control.list.soundField.clearAudio")));
                    soundField.append($("<option></option>").val("music").text(node._("control.list.soundField.music")));
                    soundField.append($("<option></option>").val("movie").text(node._("control.list.soundField.movie")));
                    soundField.append($("<option></option>").val("sports").text(node._("control.list.soundField.sports")));
                    soundField.append($("<option></option>").val("game").text(node._("control.list.soundField.game")));

                    let voiceTypeContainer = $("<span/>", {id: "item-elem-voiceType-" + index,
                                                           style: "padding-left: 10px;"}).appendTo(item);
                    let voiceType = $("<select/>", {class: "node-input-voiceType",
                                                    style: "width: auto;"}).appendTo(voiceTypeContainer);
                    voiceType.append($("<option></option>").val("type1").text(node._("control.list.voiceType.type1")));
                    voiceType.append($("<option></option>").val("type2").text(node._("control.list.voiceType.type2")));
                    voiceType.append($("<option></option>").val("type3").text(node._("control.list.voiceType.type3")));

                    let switchedOnContainer = $("<span/>", {id: "item-elem-switchedOn-" + index,
                                                            style: "padding-left: 10px;"}).appendTo(item);
                    let switchedOn = $("<input/>", {id: "node-input-switchedOn-" + index,
                                                    class: "node-input-switchedOn",
                                                    type: "checkbox",
                                                    style: "vertical-align: text-bottom; width: auto;"}).appendTo(switchedOnContainer);
                    $("<label/>", {for: "node-input-switchedOn-" + index,
                                   style: "padding-left: 4px;"}).text(node._("control.label.switchedOn")).appendTo(switchedOnContainer);

                    soundTarget.change(function()
                    {
                        value = soundTarget.val();

                        soundFieldContainer.hide();
                        voiceTypeContainer.hide();
                        switchedOnContainer.hide();

                        if (value == "soundField")
                        {
                            soundFieldContainer.show();
                        }
                        else if (value == "voice")
                        {
                            voiceTypeContainer.show();
                        }
                        else
                        {
                            switchedOnContainer.show();
                        }
                    });

                    if (soundSetting.target == "soundField")
                    {
                        soundField.val(soundSetting.value);
                    }
                    else if (soundSetting.target == "voice")
                    {
                        voiceType.val(soundSetting.value);
                    }
                    else
                    {
                        switchedOn.prop("checked", (soundSetting.value == "on"));
                    }

                    soundTarget.val(soundSetting.target);
                    soundTarget.change();
                }
            });

            let speakerSettingsList = $("#node-input-speakerSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                addItem: function(item, index, speakerSetting)
                {
                    if (!("target" in speakerSetting))
                    {
                        speakerSetting.target = "inCeilingSpeakerMode";
                        speakerSetting.value = "off";
                    }

                    const speakerLevelSpinner =
                    {
                        min: -10,
                        max: 10,
                        step: 0.5,
                        change: function(event, ui)
                        {
                            var value = parseFloat($(this).spinner("value"));
                            var min = $(this).spinner("option", "min");
                            var max = $(this).spinner("option", "max");
                            if (isNaN(value) ||
                                (value < min))
                            {
                                $(this).spinner("value", min);
                            }
                            else if (value > max)
                            {
                                $(this).spinner("value", max);
                            }
                            else if ((value % 0.5) != 0)
                            {
                                $(this).spinner("value", value - (value % 0.5));
                            }
                        }
                    };

                    let speakerTarget = $("<select/>", {class: "node-input-speakerTarget"}).appendTo(item);
                    speakerTarget.append($("<option></option>").val("inCeilingSpeakerMode").text(node._("control.list.speakerTarget.inCeilingSpeakerMode")));
                    speakerTarget.append($("<option></option>").val("speakerSelection").text(node._("control.list.speakerTarget.speakerSelection")));
                    speakerTarget.append($("<option></option>").val("frontLLevel").text(node._("control.list.speakerTarget.frontLLevel")));
                    speakerTarget.append($("<option></option>").val("frontRLevel").text(node._("control.list.speakerTarget.frontRLevel")));
                    speakerTarget.append($("<option></option>").val("centerLevel").text(node._("control.list.speakerTarget.centerLevel")));
                    speakerTarget.append($("<option></option>").val("surroundLLevel").text(node._("control.list.speakerTarget.surroundLLevel")));
                    speakerTarget.append($("<option></option>").val("surroundRLevel").text(node._("control.list.speakerTarget.surroundRLevel")));
                    speakerTarget.append($("<option></option>").val("surroundcBackLevel").text(node._("control.list.speakerTarget.surroundcBackLevel")));
                    speakerTarget.append($("<option></option>").val("surroundBackLLevel").text(node._("control.list.speakerTarget.surroundBackLLevel")));
                    speakerTarget.append($("<option></option>").val("surroundBackRLevel").text(node._("control.list.speakerTarget.surroundBackRLevel")));
                    speakerTarget.append($("<option></option>").val("heightLLevel").text(node._("control.list.speakerTarget.heightLLevel")));
                    speakerTarget.append($("<option></option>").val("heightRLevel").text(node._("control.list.speakerTarget.heightRLevel")));
                    speakerTarget.append($("<option></option>").val("subwooferLevel").text(node._("control.list.speakerTarget.subwooferLevel")));

                    let inCeilingSpeakerModeContainer = $("<span/>", {style: "padding-left: 10px;"}).appendTo(item);
                    let inCeilingSpeakerMode = $("<select/>", {class: "node-input-inCeilingSpeakerMode",
                                                               style: "width: auto;"}).appendTo(inCeilingSpeakerModeContainer);
                    inCeilingSpeakerMode.append($("<option></option>").val("off").text(node._("control.list.inCeilingSpeakerMode.off")));
                    inCeilingSpeakerMode.append($("<option></option>").val("front").text(node._("control.list.inCeilingSpeakerMode.front")));
                    inCeilingSpeakerMode.append($("<option></option>").val("front&center").text(node._("control.list.inCeilingSpeakerMode.front_center")));

                    let speakerSelectionContainer = $("<span/>", {style: "padding-left: 10px;"}).appendTo(item);
                    let speakerSelection = $("<select/>", {class: "node-input-speakerSelection",
                                                           style: "width: auto;"}).appendTo(speakerSelectionContainer);
                    speakerSelection.append($("<option></option>").val("off").text(node._("control.list.speakerSelection.off")));
                    speakerSelection.append($("<option></option>").val("speakerA").text(node._("control.list.speakerSelection.speakerA")));
                    speakerSelection.append($("<option></option>").val("speakerB").text(node._("control.list.speakerSelection.speakerB")));
                    speakerSelection.append($("<option></option>").val("speakerA_B").text(node._("control.list.speakerSelection.speakerA_B")));

                    let speakerLevelContainer = $("<span/>", {style: "padding-left: 10px;"}).appendTo(item);
                    let speakerLevel = $("<input/>", {class: "node-input-speakerLevel", style: "width: 50px;"})
                                        .appendTo(speakerLevelContainer)
                                        .spinner(speakerLevelSpinner)
                                        .spinner("value", 0);

                    speakerTarget.change(function()
                    {
                        value = speakerTarget.val();

                        inCeilingSpeakerModeContainer.hide();
                        speakerSelectionContainer.hide();
                        speakerLevelContainer.hide();

                        if (value == "inCeilingSpeakerMode")
                        {
                            inCeilingSpeakerModeContainer.show();
                        }
                        else if (value == "speakerSelection")
                        {
                            speakerSelectionContainer.show();
                        }
                        else
                        {
                            speakerLevelContainer.show();
                        }
                    });

                    if (speakerSetting.target == "inCeilingSpeakerMode")
                    {
                        inCeilingSpeakerMode.val(speakerSetting.value);
                    }
                    else if (speakerSetting.target == "speakerSelection")
                    {
                        speakerSelection.val(speakerSetting.value);
                    }
                    else
                    {
                        speakerLevel.spinner("value", speakerSetting.value);
                    }

                    speakerTarget.val(speakerSetting.target);
                    speakerTarget.change();
                }
            });

            let modeSettingsList = $("#node-input-modeSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                addItem: function(item, index, modeSetting)
                {
                    if (!("target" in modeSetting))
                    {
                        modeSetting.target = "playType";
                        modeSetting.value = "normal";
                    }

                    let modeTarget = $("<select/>", {class: "node-input-modeTarget"}).appendTo(item);
                    modeTarget.append($("<option></option>").val("playType").text(node._("control.list.modeTarget.playType")));
                    modeTarget.append($("<option></option>").val("repeatType").text(node._("control.list.modeTarget.repeatType")));
                    modeTarget.append($("<option></option>").val("shuffleType").text(node._("control.list.modeTarget.shuffleType")));

                    let playTypeContainer = $("<span/>", {id: "item-elem-playType-" + index,
                                                            style: "padding-left: 10px;"}).appendTo(item);
                    let playType = $("<select/>", {class: "node-input-playType",
                                                   style: "width: auto;"}).appendTo(playTypeContainer);
                    playType.append($("<option></option>").val("normal").text(node._("control.list.playType.normal")));
                    playType.append($("<option></option>").val("repeatAll").text(node._("control.list.playType.repeatAll")));
                    playType.append($("<option></option>").val("repeatFolder").text(node._("control.list.playType.repeatFolder")));
                    playType.append($("<option></option>").val("repeatTrack").text(node._("control.list.playType.repeatTrack")));
                    playType.append($("<option></option>").val("shuffleAll").text(node._("control.list.playType.shuffleAll")));

                    let repeatTypeContainer = $("<span/>", {id: "item-elem-repeatType-" + index,
                                                            style: "padding-left: 10px;"}).appendTo(item);
                    let repeatType = $("<select/>", {class: "node-input-repeatType",
                                                    style: "width: auto;"}).appendTo(repeatTypeContainer);
                    repeatType.append($("<option></option>").val("off").text(node._("control.list.repeatType.off")));
                    repeatType.append($("<option></option>").val("all").text(node._("control.list.repeatType.all")));
                    repeatType.append($("<option></option>").val("folder").text(node._("control.list.repeatType.folder")));
                    repeatType.append($("<option></option>").val("track").text(node._("control.list.repeatType.track")));
                    repeatType.append($("<option></option>").val("chapter").text(node._("control.list.repeatType.chapter")));

                    let shuffleTypeContainer = $("<span/>", {id: "item-elem-shuffleType-" + index,
                                                             style: "padding-left: 10px;"}).appendTo(item);
                    let shuffleType = $("<select/>", {class: "node-input-shuffleType",
                                                      style: "width: auto;"}).appendTo(shuffleTypeContainer);
                    shuffleType.append($("<option></option>").val("off").text(node._("control.list.shuffleType.off")));
                    shuffleType.append($("<option></option>").val("folder").text(node._("control.list.shuffleType.folder")));

                    modeTarget.change(function()
                    {
                        value = modeTarget.val();

                        playTypeContainer.hide();
                        repeatTypeContainer.hide();
                        shuffleTypeContainer.hide();

                        if (value == "playType")
                        {
                            playTypeContainer.show();
                        }
                        else if (value == "repeatType")
                        {
                            repeatTypeContainer.show();
                        }
                        else if (value == "shuffleType")
                        {
                            shuffleTypeContainer.show();
                        }
                    });

                    if (modeSetting.target == "playType")
                    {
                        playType.val(modeSetting.value);
                    }
                    else if (modeSetting.target == "repeatType")
                    {
                        repeatType.val(modeSetting.value);
                    }
                    else if (modeSetting.target == "shuffleType")
                    {
                        shuffleType.val(modeSetting.value);
                    }

                    modeTarget.val(modeSetting.target);
                    modeTarget.change();
                }
            });

            let filterList = $("#node-input-filterList").css("min-height", "200px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, filter)
                {
                    if (!("name" in filter))
                    {
                        filter.name = "auto";
                    }

                    let fragment = document.createDocumentFragment();
                    let container = $("<div/>", {style: "display: inline-block; vertical-align: middle; width: auto;"}).appendTo(fragment);
                    let row1 = $("<div/>").appendTo(container);
                    let row2 = $("<div/>", {style: "margin-top: 5px; "}).appendTo(container);

                    $("<div/>", {class: "node-input-filterIndex", style: "position: absolute; width: auto; top: 50%; right: 26px; margin-top: -9px;"})
                            .html("&#8594; " + (index + 1))
                            .appendTo(fragment);

                    let filterName = $("<select/>", {class: "node-input-filterName", style: "width: auto;"})
                            .append($("<option></option>").val("auto").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.auto")))
                            .append($("<option></option>").val("powered").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.powered")))
                            .append($("<option></option>").val("standby").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.standby")))
                            .append($("<option></option>").val("swupdate").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.swupdate")))
                            .append($("<option></option>").val("source").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.source")))
                            .append($("<option></option>").val("absoluteVolume").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.absoluteVolume")))
                            .append($("<option></option>").val("relativeVolume").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.relativeVolume")))
                            .append($("<option></option>").val("muted").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.muted")))
                            .append($("<option></option>").val("soundSetting").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.soundSetting")))
                            .append($("<option></option>").val("speakerSetting").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.speakerSetting")))
                            .append($("<option></option>").val("playbackMode").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.playbackMode")))
                            .append($("<option></option>").val("custom").text(node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter.custom")))
                            .appendTo(row1);

                    let explicitContainer = $("<span/>", {id: "item-elemExplicit-" + index, style: "padding-left: 10px;"})
                            .appendTo(row1);
                    let explicit = $("<input/>", {id: "node-input-filterExplicit-" + index,
                                                  class: "node-input-filterExplicit",
                                                  type: "checkbox",
                                                  style: "vertical-align: text-bottom; width: auto;"})
                            .appendTo(explicitContainer);
                    $("<label/>", {for: "node-input-filterExplicit-" + index, style: "padding-left: 4px;"})
                            .text(node._("node-red-contrib-sony-audio/sony-audio-device:common.label.explicit"))
                            .appendTo(explicitContainer);

                    let customFilter = $("<input/>", {type: "text", class: "node-input-customFilter"})
                            .appendTo(row2)
                            .typedInput({types: ["global", "flow", "msg", "jsonata"]});
                    customFilter.typedInput("width", "280px");

                    filterName.change(function()
                    {
                        row2.hide();
                        explicitContainer.hide();

                        switch (filterName.val())
                        {
                            case "powered":
                            case "standby":
                            case "swupdate":
                            {
                                explicitContainer.show();
                                break;
                            }
                            case "custom":
                            {
                                if (!("custom" in filter))
                                {
                                    filter.custom = {type: "jsonata", value: "null"};
                                    customFilter.typedInput("value", filter.custom.value);
                                    customFilter.typedInput("type", filter.custom.type);
                                }

                                row2.show();
                                break;
                            }
                        }
                    });

                    if ("explicit" in filter)
                    {
                        explicit.prop("checked", filter.explicit);
                    }

                    if (filter.name == "custom")
                    {
                        customFilter.typedInput("value", filter.custom.value);
                        customFilter.typedInput("type", filter.custom.type);
                    }

                    filterName.val(filter.name);
                    filterName.change();

                    item[0].appendChild(fragment);
                },
                removeItem: function(filter)
                {
                    let filterList = $("#node-input-filterList").editableList("items");
                    filterList.each(function(index)
                    {
                        $(this).find(".node-input-filterIndex").html("&#8594; " + (index + 1));
                    });
                },
                sortItems: function(items)
                {
                    items.each(function(index)
                    {
                        $(this).find(".node-input-filterIndex").html("&#8594; " + (index + 1));
                    });
                }
            });

            relativeVol.change(function()
            {
                if ($(this).prop("checked"))
                {
                    volSpinner.spinner("option", "min", "-10");
                    volSpinner.spinner("option", "max", "10");
                }
                else
                {
                    volSpinner.spinner("option", "min", "0");
                    volSpinner.spinner("option", "max", "99");
                }
            });

            allZones.change(function()
            {
                if ($(this).prop("checked"))
                {
                    zoneSpinner.spinner("disable");
                    zoneSpinner.spinner("option", "min", "0");
                    zoneSpinner.spinner("value", 0);
                }
                else
                {
                    zoneSpinner.spinner("enable");
                    zoneSpinner.spinner("value", 1);
                    zoneSpinner.spinner("option", "min", "1");
                }
            });

            commandSelect.change(function()
            {
                $("#form-row-swupdate").hide();
                $("#form-row-volume").hide();
                $("#form-row-source").hide();
                $("#form-row-zone").hide();
                $("#form-row-port").hide();
                $("#form-row-preset").hide();
                $("#form-row-soundSettings").hide();
                $("#form-row-soundTarget").hide();
                $("#form-row-speakerSettings").hide();
                $("#form-row-speakerTarget").hide();
                $("#form-row-modeSettings").hide();
                $("#form-row-modeTarget").hide();

                let value = $(this).val();
                switch (value)
                {
                    case "getSWUpdateInfo":
                    {
                        $("#form-row-swupdate").show();
                        break;
                    }
                    case "setSource":
                    {
                        $("#form-row-source").show();
                        $("#form-row-zone").show();

                        if ((sourceSelect.val() == "extInput:hdmi") ||
                            (sourceSelect.val() == "extInput:video") ||
                            (sourceSelect.val() == "extInput:line"))
                        {
                            $("#form-row-port").show();
                        }
                        else if (sourceSelect.val() == "radio:fm")
                        {
                            $("#form-row-preset").show();
                        }

                        break;
                    }
                    case "setVolume":
                    {
                        $("#form-row-volume").show();
                        $("#form-row-zone").show();

                        break;
                    }
                    case "mute":
                    case "unmute":
                    case "toggleMute":
                    case "getSource":
                    case "stop":
                    case "togglePause":
                    case "skipPrev":
                    case "skipNext":
                    case "scanForward":
                    case "scanBackward":
                    case "getVolumeInfo":
                    {
                        $("#form-row-zone").show();
                        break;
                    }
                    case "setSoundSettings":
                    {
                        $("#form-row-soundSettings").show();
                        break;
                    }
                    case "getSoundSettings":
                    {
                        $("#form-row-soundTarget").show();
                        break;
                    }
                    case "setSpeakerSettings":
                    {
                        $("#form-row-speakerSettings").show();
                        break;
                    }
                    case "getSpeakerSettings":
                    {
                        $("#form-row-speakerTarget").show();
                        break;
                    }
                    case "setPlaybackSettings":
                    {
                        $("#form-row-modeSettings").show();
                        break;
                    }
                    case "getPlaybackSettings":
                    {
                        $("#form-row-modeTarget").show();
                        break;
                    }
                }
            });

            sourceSelect.change(function()
            {
                if (commandSelect.val() == "setSource")
                {
                    if (($(this).val() == "extInput:hdmi") ||
                        ($(this).val() == "extInput:video") ||
                        ($(this).val() == "extInput:line"))
                    {
                        $("#form-row-port").show();
                    }
                    else
                    {
                        $("#form-row-port").hide();
                    }

                    if ($(this).val() == "radio:fm")
                    {
                        $("#form-row-preset").show();
                    }
                    else
                    {
                        $("#form-row-preset").hide();
                    }
                }
            });

            outFiltersSelect.change(function()
            {
                if ($(this).prop("checked"))
                {
                    $("#form-row-filterList").show();
                }
                else
                {
                    $("#form-row-filterList").hide();
                }
            });

            if (node.zone == 0)
            {
                allZones.prop("checked", true);
                zoneSpinner.spinner("disable");
                zoneSpinner.spinner("option", "min", "0");
            }

            node.soundSettings.forEach(setting =>
            {
                soundSettingsList.editableList("addItem", setting);
            });

            node.speakerSettings.forEach(setting =>
            {
                speakerSettingsList.editableList("addItem", setting);
            });

            node.modeSettings.forEach(setting =>
            {
                modeSettingsList.editableList("addItem", setting);
            });

            node.outputPorts.forEach(port =>
            {
                if ("filter" in port)
                {
                    filterList.editableList("addItem", port.filter);
                }
            });

            outFiltersSelect.change();
            commandSelect.change();
        },
        oneditsave: function()
        {
            let node = this;
            let soundSettingsList = $("#node-input-soundSettingsList").editableList("items");
            let speakerSettingsList = $("#node-input-speakerSettingsList").editableList("items");
            let modeSettingsList = $("#node-input-modeSettingsList").editableList("items");

            node.soundSettings = [];
            soundSettingsList.each(function(index)
            {
                let setting = {target: $(this).find(".node-input-soundTarget").val()};
                if (setting.target == "soundField")
                {
                    setting.value = $(this).find(".node-input-soundField").val();
                }
                else if (setting.target == "voice")
                {
                    setting.value = $(this).find(".node-input-voiceType").val();
                }
                else
                {
                    setting.value = $(this).find(".node-input-switchedOn").prop("checked") ? "on" : "off";
                }

                node.soundSettings.push(setting);
            });

            node.speakerSettings = [];
            speakerSettingsList.each(function(index)
            {
                let setting = {target: $(this).find(".node-input-speakerTarget").val()};
                if (setting.target == "inCeilingSpeakerMode")
                {
                    setting.value = $(this).find(".node-input-inCeilingSpeakerMode").val();
                }
                else if (setting.target == "speakerSelection")
                {
                    setting.value = $(this).find(".node-input-speakerSelection").val();
                }
                else
                {
                    setting.value = $(this).find(".node-input-speakerLevel").spinner("value");
                }
                console.log("setting: " + JSON.stringify(setting));

                node.speakerSettings.push(setting);
            });

            node.modeSettings = [];
            modeSettingsList.each(function(index)
            {
                let setting = {target: $(this).find(".node-input-modeTarget").val()};
                if (setting.target == "playType")
                {
                    setting.value = $(this).find(".node-input-playType").val();
                }
                else if (setting.target == "repeatType")
                {
                    setting.value = $(this).find(".node-input-repeatType").val();
                }
                else if (setting.target == "shuffleType")
                {
                    setting.value = $(this).find(".node-input-shuffleType").val();
                }

                node.modeSettings.push(setting);
            });

            node.outputPorts = [];
            node.outputs = 0;

            if ($("#node-input-outFilters").prop("checked"))
            {
                let filterList = $("#node-input-filterList").editableList("items");

                filterList.each(function(index)
                {
                    let filter = {name: $(this).find(".node-input-filterName").val()};

                    if ((filter.name == "powered") || (filter.name == "standby") || (filter.name == "swupdate"))
                    {
                        filter.explicit = $(this).find(".node-input-filterExplicit").prop("checked");
                    }
                    else if (filter.name == "custom")
                    {
                        let customFilter = $(this).find(".node-input-customFilter");

                        filter.custom = {type: customFilter.typedInput("type"),
                                         value: customFilter.typedInput("value")};
                    }

                    node.outputPorts.push({label: node._("node-red-contrib-sony-audio/sony-audio-device:common.label.filterPort") + ": " + node._("node-red-contrib-sony-audio/sony-audio-device:common.list.filter." + filter.name), filter: filter});
                    node.outputs++;
                });
            }

            if ($("#node-input-outResponse").prop("checked"))
            {
                node.outputPorts.push({label: node._("control.label.responsePort")});
                node.outputs++;
            }
        }
    });
</script>
