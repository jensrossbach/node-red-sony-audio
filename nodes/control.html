<!--
Copyright (c) 2024 Jens-Uwe Rossbach

This code is licensed under the MIT License.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->

<script type="text/html" data-template-name="sonyaudio-control">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-cog"></i> <span data-i18n="@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.device"></span></label>
        <input type="text" id="node-input-device" data-i18n="[placeholder]@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.device">
    </div>
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-exchange"></i> <span data-i18n="control.label.action"></span></label>
        <input id="node-input-action" type="text" style="width: 70%;">
        <input id="node-input-actionType" type="hidden">
    </div>
    <div class="form-row" id="form-row-api">
        <label for="node-input-api"><i class="fa fa-plug"></i> <span data-i18n="control.label.api"></span></label>
        <input id="node-input-api" type="text" style="width: 70%;">
        <input id="node-input-apiType" type="hidden">
    </div>
    <div class="form-row" id="form-row-params">
        <label for="node-input-params"><i class="fa fa-ellipsis-h"></i> <span data-i18n="control.label.params"></span></label>
        <input id="node-input-params" type="text" style="width: 70%;">
        <input id="node-input-paramsType" type="hidden">
    </div>
    <div id="form-row-swupdate" class="form-row">
        <label><i class="fa fa-check-square-o"></i> <span data-i18n="control.label.options"></span></label>
        <span>
            <input id="node-input-networkUpdate" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
            <label for="node-input-networkUpdate" style="margin-bottom: 0px; width: auto;" data-i18n="control.label.networkUpdate"></label>
        </span>
    </div>
    <div id="form-row-volume" class="form-row">
        <label for="node-input-volume"><i class="fa fa-volume-up"></i> <span data-i18n="control.label.volume"></span></label>
        <input id="node-input-volume" style="width: 60px !important; float: left;" value="1">
        <span style="padding-left: 10px;">
            <input id="node-input-relativeVolume" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
            <label for="node-input-relativeVolume" style="margin-bottom: 0px; width: auto;" data-i18n="control.label.relativeVolume"></label>
        </span>
    </div>
    <div id="form-row-source" class="form-row">
        <label for="node-input-source"><i class="fa fa-sign-in"></i> <span data-i18n="control.label.audioSource"></span></label>
        <select id="node-input-source" style="width: auto;">
            <option value="extInput:tv" data-i18n="control.list.source.tv"></option>
            <option value="extInput:sat-catv" data-i18n="control.list.source.satcatv"></option>
            <option value="extInput:hdmi" data-i18n="control.list.source.hdmi"></option>
            <option value="extInput:video" data-i18n="control.list.source.video"></option>
            <option value="extInput:sacd-cd" data-i18n="control.list.source.sacdcd"></option>
            <option value="extInput:bd-dvd" data-i18n="control.list.source.bddvd"></option>
            <option value="storage:usb1" data-i18n="control.list.source.usb"></option>
            <option value="extInput:line" data-i18n="control.list.source.line"></option>
            <option value="extInput:btAudio" data-i18n="control.list.source.bt"></option>
            <option value="dlna:music" data-i18n="control.list.source.dlna"></option>
            <option value="radio:fm" data-i18n="control.list.source.fm"></option>
            <option value="extInput:game" data-i18n="control.list.source.game"></option>
            <option value="extInput:source" data-i18n="control.list.source.source"></option>
        </select>
    </div>
    <div id="form-row-port" class="form-row">
        <label for="node-input-port"><i class="fa fa-bookmark"></i> <span data-i18n="control.label.port"></span></label>
        <input id="node-input-port" style="width: 60px !important;" value="1">
    </div>
    <div id="form-row-preset" class="form-row">
        <label for="node-input-preset"><i class="fa fa-bookmark"></i> <span data-i18n="control.label.preset"></span></label>
        <input id="node-input-preset" style="width: 60px !important;" value="0">
    </div>
    <div id="form-row-zone" class="form-row">
        <label for="node-input-zone"><i class="fa fa-code-fork"></i> <span data-i18n="control.label.zone"></span></label>
        <input id="node-input-zone" style="width: 60px !important;" value="1">
        <span style="padding-left: 10px;">
            <input id="node-input-allzones" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
            <label for="node-input-allzones" style="margin-bottom: 0px; width: auto;" data-i18n="control.label.allZones"></label>
        </span>
    </div>
    <div id="form-row-soundSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.settings"></span></label>
        <div class="form-row">
            <ol id="node-input-soundSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-soundTarget" class="form-row">
        <label for="node-input-soundTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.setting"></span></label>
        <select id="node-input-soundTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.soundTarget.all"></option>
            <option value="soundField" data-i18n="control.list.soundTarget.soundField"></option>
            <option value="clearAudio" data-i18n="control.list.soundTarget.clearAudio"></option>
            <option value="nightMode" data-i18n="control.list.soundTarget.nightMode"></option>
            <option value="footballMode" data-i18n="control.list.soundTarget.footballMode"></option>
            <option value="voice" data-i18n="control.list.soundTarget.voice"></option>
        </select>
    </div>
    <div id="form-row-speakerSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.settings"></span></label>
        <div class="form-row">
            <ol id="node-input-speakerSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-speakerTarget" class="form-row">
        <label for="node-input-speakerTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.setting"></span></label>
        <select id="node-input-speakerTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.speakerTarget.all"></option>
            <option value="inCeilingSpeakerMode" data-i18n="control.list.speakerTarget.inCeilingSpeakerMode"></option>
            <option value="speakerSelection" data-i18n="control.list.speakerTarget.speakerSelection"></option>
            <option value="frontLLevel" data-i18n="control.list.speakerTarget.frontLLevel"></option>
            <option value="frontRLevel" data-i18n="control.list.speakerTarget.frontRLevel"></option>
            <option value="centerLevel" data-i18n="control.list.speakerTarget.centerLevel"></option>
            <option value="surroundLLevel" data-i18n="control.list.speakerTarget.surroundLLevel"></option>
            <option value="surroundRLevel" data-i18n="control.list.speakerTarget.surroundRLevel"></option>
            <option value="surroundcBackLevel" data-i18n="control.list.speakerTarget.surroundcBackLevel"></option>
            <option value="surroundBackLLevel" data-i18n="control.list.speakerTarget.surroundBackLLevel"></option>
            <option value="surroundBackRLevel" data-i18n="control.list.speakerTarget.surroundBackRLevel"></option>
            <option value="heightLLevel" data-i18n="control.list.speakerTarget.heightLLevel"></option>
            <option value="heightRLevel" data-i18n="control.list.speakerTarget.heightRLevel"></option>
            <option value="subwooferLevel" data-i18n="control.list.speakerTarget.subwooferLevel"></option>
        </select>
    </div>
    <div id="form-row-modeSettings" class="form-row" style="padding-top: 10px">
        <label><i class="fa fa-sliders"></i> <span data-i18n="control.label.modes"></span></label>
        <div class="form-row">
            <ol id="node-input-modeSettingsList"></ol>
        </div>
    </div>
    <div id="form-row-modeTarget" class="form-row">
        <label for="node-input-modeTarget"><i class="fa fa-sliders"></i> <span data-i18n="control.label.mode"></span></label>
        <select id="node-input-modeTarget" style="width: auto;">
            <option value="all" data-i18n="control.list.modeTarget.all"></option>
            <option value="playType" data-i18n="control.list.modeTarget.playType"></option>
            <option value="repeatType" data-i18n="control.list.modeTarget.repeatType"></option>
            <option value="shuffleType" data-i18n="control.list.modeTarget.shuffleType"></option>
            <option value="autoPlayback" data-i18n="control.list.modeTarget.autoPlayback"></option>
        </select>
    </div>
    <div class="form-row form-row-output" style="padding-top: 10px">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.output"></span></label>
        <div class="form-row">
            <ol id="node-input-propertyList"></ol>
        </div>
    </div>
    <div class="form-row">
        <input id="node-input-msgPassThrough" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
        <label for="node-input-msgPassThrough" style="margin-bottom: 0px; width: auto;" data-i18n="control.label.msgPassThrough"></label>
    </div>
    <div class="form-row">
        <input id="node-input-sendIfPayload" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
        <label for="node-input-sendIfPayload" style="margin-bottom: 0px; width: auto;" data-i18n="[html]@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.sendIfPayload"></label>
    </div>
</script>

<script type="text/javascript">
    function resizeEdit(size)
    {
        let height = size.height;
        let propertyListRow = $("#dialog-form>div.form-row-output");
        let otherRows = $("#dialog-form>div:not(.form-row-output)");

        for (let i=0; i<otherRows.length; ++i)
        {
            if ($(otherRows[i]).is(":visible"))
            {
                height -= $(otherRows[i]).outerHeight(true);
            }
        }

        height -= (parseInt(propertyListRow.css("marginTop")) + parseInt(propertyListRow.css("marginBottom")));
        height -= $("#dialog-form>div.form-row-output>label").outerHeight(true);

        $("#node-input-propertyList").editableList("height", height);
    }

    RED.nodes.registerType("sonyaudio-control",
    {
        category:     "sony audio",
        color:        "#2DABCE",
        icon:         "sony.png",
        inputs:       1,
        outputs:      1,
        inputLabels: function()
        {
            return this._("control.label.inputPort");
        },
        paletteLabel: "control",
        label: function()
        {
            if (this.name)
            {
                return this.name;
            }
            else if (this.actionType == "api")
            {
                if ((this.apiType == "msg") || (this.apiType == "global") || (this.apiType == "flow"))
                {
                    return this.apiType + "." + this.api;
                }
                else if (this.apiType == "env")
                {
                    return "env: " + this.api;
                }
                else
                {
                    return this.api;
                }
            }
            else
            {
                return this._("control.list." + this.actionType + "." + this.action);
            }
        },
        labelStyle: function()
        {
            return (this.name ? "node_label_italic" : "");
        },
        outputLabels: function(index)
        {
            return this._("control.label.outputPort");
        },
        defaults:
        {
            outputs:
            {
                value: 1
            },
            name:
            {
                value: ""
            },
            device:
            {
                value: "",
                type:  "sonyaudio-device"
            },
            action:
            {
                value: "powerOn"
            },
            actionType:
            {
                value: "control"
            },
            api:
            {
                value: "system.setPowerStatus@1.1"
            },
            apiType:
            {
                value: "str"
            },
            params:
            {
                value: "{\"status\": \"active\"}"
            },
            paramsType:
            {
                value: "json"
            },
            networkUpdate:
            {
                value: true
            },
            volume:
            {
                value: "1"
            },
            relativeVolume:
            {
                value: false
            },
            source:
            {
                value: "extInput:tv"
            },
            port:
            {
                value: "1"
            },
            preset:
            {
                value: "0"
            },
            zone:
            {
                value: "0"
            },
            soundSettings:
            {
                value: [{target: "soundField", value: "clearAudio"}]
            },
            soundTarget:
            {
                value: "soundField"
            },
            speakerSettings:
            {
                value: [{target: "inCeilingSpeakerMode", value: "off"}]
            },
            speakerTarget:
            {
                value: "inCeilingSpeakerMode"
            },
            modeSettings:
            {
                value: [{target: "playType", value: "normal"}]
            },
            modeTarget:
            {
                value: "playType"
            },
            outputProperties:
            {
                value: [{type: "msg", name: "topic", value: {type: "str", content: "{{host}}/{{service}}.{{method}}@{{version}}"}},
                        {type: "msg", name: "payload", value: {type: "filtered", content: "auto"}}]
            },
            msgPassThrough:
            {
                value: true
            },
            sendIfPayload:
            {
                value: true
            }
        },
        oneditprepare: function()
        {
            const node = this;
            const sourceSelect = $("#node-input-source");
            const relativeVol = $("#node-input-relativeVolume");
            const allZones = $("#node-input-allzones");

            const controlType =
            {
                value: "control",
                label: node._("control.label.control"),
                icon: "fa fa-cogs",
                options:
                [
                    {
                        value: "powerOn",
                        label: node._("control.list.control.powerOn")
                    },
                    {
                        value: "powerOff",
                        label: node._("control.list.control.powerOff")
                    },
                    {
                        value: "standBy",
                        label: node._("control.list.control.standBy")
                    },
                    {
                        value: "reconnect",
                        label: node._("control.list.control.reconnect")
                    },
                    {
                        value: "setVolume",
                        label: node._("control.list.control.setVolume")
                    },
                    {
                        value: "mute",
                        label: node._("control.list.control.mute")
                    },
                    {
                        value: "unmute",
                        label: node._("control.list.control.unmute")
                    },
                    {
                        value: "toggleMute",
                        label: node._("control.list.control.toggleMute")
                    },
                    {
                        value: "setSource",
                        label: node._("control.list.control.setSource")
                    },
                    {
                        value: "setSoundSettings",
                        label: node._("control.list.control.setSoundSettings")
                    },
                    {
                        value: "setSpeakerSettings",
                        label: node._("control.list.control.setSpeakerSettings")
                    },
                    {
                        value: "setPlaybackSettings",
                        label: node._("control.list.control.setPlaybackSettings")
                    },
                    {
                        value: "stop",
                        label: node._("control.list.control.stop")
                    },
                    {
                        value: "togglePause",
                        label: node._("control.list.control.togglePause")
                    },
                    {
                        value: "skipPrev",
                        label: node._("control.list.control.skipPrev")
                    },
                    {
                        value: "skipNext",
                        label: node._("control.list.control.skipNext")
                    },
                    {
                        value: "scanBackward",
                        label: node._("control.list.control.scanBackward")
                    },
                    {
                        value: "scanForward",
                        label: node._("control.list.control.scanForward")
                    }
                ]
            };

            const retrieveType =
            {
                value: "retrieve",
                label: node._("control.label.retrieve"),
                icon: "fa fa-download",
                options:
                [
                    {
                        value: "getPowerStatus",
                        label: node._("control.list.retrieve.getPowerStatus")
                    },
                    {
                        value: "getSWUpdateInfo",
                        label: node._("control.list.retrieve.getSWUpdateInfo")
                    },
                    {
                        value: "getVolumeInfo",
                        label: node._("control.list.retrieve.getVolumeInfo")
                    },
                    {
                        value: "getSource",
                        label: node._("control.list.retrieve.getSource")
                    },
                    {
                        value: "getSoundSettings",
                        label: node._("control.list.retrieve.getSoundSettings")
                    },
                    {
                        value: "getSpeakerSettings",
                        label: node._("control.list.retrieve.getSpeakerSettings")
                    },
                    {
                        value: "getPlaybackSettings",
                        label: node._("control.list.retrieve.getPlaybackSettings")
                    }
                ]
            };

            const callAPIType =
            {
                value: "api",
                label: node._("control.label.callAPI"),
                icon: "fa fa-plug",
                hasValue: false
            };

            const filteredDataType =
            {
                value: "filtered",
                label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.filteredData"),
                icon: "fa fa-filter",
                options:
                [
                    {
                        value: "auto",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.auto")
                    },
                    {
                        value: "powered",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.powered")
                    },
                    {
                        value: "standby",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.standby")
                    },
                    {
                        value: "swupdate",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.swupdate")
                    },
                    {
                        value: "absoluteVolume",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.absoluteVolume")
                    },
                    {
                        value: "relativeVolume",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.relativeVolume")
                    },
                    {
                        value: "muted",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.muted")
                    },
                    {
                        value: "source",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.source")
                    },
                    {
                        value: "soundSetting",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.soundSetting")
                    },
                    {
                        value: "speakerSetting",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.speakerSetting")
                    },
                    {
                        value: "playbackSetting",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.filteredData.playbackSetting")
                    }
                ]
            };

            const unfilteredDataType =
            {
                value: "unfiltered",
                label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.label.unfilteredData"),
                icon: "fa fa-file-text-o",
                options:
                [
                    {
                        value: "all",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.all")
                    },
                    {
                        value: "host",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.host")
                    },
                    {
                        value: "service",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.service")
                    },
                    {
                        value: "method",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.method")
                    },
                    {
                        value: "version",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.version")
                    },
                    {
                        value: "payload",
                        label: node._("@jens_rossbach/node-red-sony-audio/sonyaudio-device:common.list.unfilteredData.payload")
                    }
                ]
            };

            const validateVolume = function(event, ui)
            {
                let value = parseInt($(this).spinner("value"), 10);
                let min = $(this).spinner("option", "min");
                let max = $(this).spinner("option", "max");

                if (isNaN(value) || (value < min))
                {
                    $(this).spinner("value", min);
                }
                else if (value > max)
                {
                    $(this).spinner("value", max);
                }

                if ((min < 0) && (value == 0))
                {
                    $(this).spinner("value", 1);
                }
            };

            const validateZonePortPreset = function(event, ui)
            {
                let value = parseInt($(this).spinner("value"), 10);
                let min = $(this).spinner("option", "min");
                let max = $(this).spinner("option", "max");

                if (isNaN(value) || (value < min))
                {
                    $(this).spinner("value", min);
                }
                else if (value > max)
                {
                    $(this).spinner("value", max);
                }
            };

            const volSpinner = $("#node-input-volume").spinner(
            {
                min: 0,
                max: 99,
                step: 1,
                numberFormat: "n",
                change: validateVolume
            });

            const portSpinner = $("#node-input-port").spinner(
            {
                min: 1,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            const presetSpinner = $("#node-input-preset").spinner(
            {
                min: 0,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            const zoneSpinner = $("#node-input-zone").spinner(
            {
                min: 1,
                max: 99,
                step: 1,
                change: validateZonePortPreset
            });

            const action = $("#node-input-action").typedInput({types: [controlType, retrieveType, callAPIType], typeField: "#node-input-actionType"});
            const api = $("#node-input-api").typedInput({types: ["str", "env", "global", "flow", "msg"], typeField: "#node-input-apiType"});
            const params = $("#node-input-params").typedInput({types: ["json", "jsonata", "env", "global", "flow", "msg"], typeField: "#node-input-paramsType"});

            const soundSettingsList = $("#node-input-soundSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, soundSetting)
                {
                    if (!("target" in soundSetting))
                    {
                        soundSetting.target = "soundField";
                        soundSetting.value = "off";
                    }

                    item.css({overflow: "hidden", whiteSpace: "nowrap"});

                    const row = $("<div/>").appendTo(item);

                    const soundTarget = $("<select/>", {class: "node-input-soundTarget", style: "width: auto;"})
                            .append($("<option></option>").val("soundField").text(node._("control.list.soundTarget.soundField")))
                            .append($("<option></option>").val("clearAudio").text(node._("control.list.soundTarget.clearAudio")))
                            .append($("<option></option>").val("nightMode").text(node._("control.list.soundTarget.nightMode")))
                            .append($("<option></option>").val("footballMode").text(node._("control.list.soundTarget.footballMode")))
                            .append($("<option></option>").val("voice").text(node._("control.list.soundTarget.voice")))
                            .appendTo(row);

                    $("<div/>", {style: "display:inline-block; padding: 0px 6px;"})
                        .text('=')
                        .appendTo(row);

                    const soundField = $("<select/>", {class: "node-input-soundField", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.soundField.off")))
                            .append($("<option></option>").val("standard").text(node._("control.list.soundField.standard")))
                            .append($("<option></option>").val("direct").text(node._("control.list.soundField.direct")))
                            .append($("<option></option>").val("music").text(node._("control.list.soundField.music")))
                            .append($("<option></option>").val("movie").text(node._("control.list.soundField.movie")))
                            .append($("<option></option>").val("sports").text(node._("control.list.soundField.sports")))
                            .append($("<option></option>").val("game").text(node._("control.list.soundField.game")))
                            .append($("<option></option>").val("clearAudio").text(node._("control.list.soundField.clearAudio")))
                            .append($("<option></option>").val("audioEnhancer").text(node._("control.list.soundField.audioEnhancer")))
                            .append($("<option></option>").val("neuralX").text(node._("control.list.soundField.neuralX")))
                            .append($("<option></option>").val("2chStereo").text(node._("control.list.soundField.2chStereo")))
                            .append($("<option></option>").val("multiChStereo").text(node._("control.list.soundField.multiChStereo")))
                            .append($("<option></option>").val("audioFormatDecoding").text(node._("control.list.soundField.audioFormatDecoding")))
                            .append($("<option></option>").val("dolbySurround").text(node._("control.list.soundField.dolbySurround")))
                            .append($("<option></option>").val("frontSurround").text(node._("control.list.soundField.frontSurround")))
                            .appendTo(row);

                    const footballMode = $("<select/>", {class: "node-input-footballMode", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.footballMode.off")))
                            .append($("<option></option>").val("on").text(node._("control.list.footballMode.on")))
                            .append($("<option></option>").val("on_narration_off").text(node._("control.list.footballMode.onNarrationOff")))
                            .appendTo(row);

                    const voiceType = $("<select/>", {class: "node-input-voiceType", style: "width: auto;"})
                            .append($("<option></option>").val("type1").text(node._("control.list.voiceType.type1")))
                            .append($("<option></option>").val("type2").text(node._("control.list.voiceType.type2")))
                            .append($("<option></option>").val("type3").text(node._("control.list.voiceType.type3")))
                            .appendTo(row);

                    const switchedOn = $("<select/>", {class: "node-input-switchedOn", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.switch.off")))
                            .append($("<option></option>").val("on").text(node._("control.list.switch.on")))
                            .appendTo(row);

                    soundTarget.change(function()
                    {
                        value = soundTarget.val();

                        soundField.hide();
                        footballMode.hide();
                        voiceType.hide();
                        switchedOn.hide();

                        if (value == "soundField")
                        {
                            soundField.show();
                        }
                        else if (value == "footballMode")
                        {
                            footballMode.show();
                        }
                        else if (value == "voice")
                        {
                            voiceType.show();
                        }
                        else
                        {
                            switchedOn.show();
                        }
                    });

                    if (soundSetting.target == "soundField")
                    {
                        soundField.val(soundSetting.value);
                    }
                    else if (soundSetting.target == "footballMode")
                    {
                        footballMode.val(soundSetting.value);
                    }
                    else if (soundSetting.target == "voice")
                    {
                        voiceType.val(soundSetting.value);
                    }
                    else
                    {
                        switchedOn.val(soundSetting.value);
                    }

                    soundTarget.val(soundSetting.target);
                    soundTarget.change();
                }
            });

            const speakerSettingsList = $("#node-input-speakerSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, speakerSetting)
                {
                    if (!("target" in speakerSetting))
                    {
                        speakerSetting.target = "inCeilingSpeakerMode";
                        speakerSetting.value = "off";
                    }

                    const speakerLevelSpinner =
                    {
                        min: -10,
                        max: 10,
                        step: 0.5,
                        change: function(event, ui)
                        {
                            var value = parseFloat($(this).spinner("value"));
                            var min = $(this).spinner("option", "min");
                            var max = $(this).spinner("option", "max");
                            if (isNaN(value) ||
                                (value < min))
                            {
                                $(this).spinner("value", min);
                            }
                            else if (value > max)
                            {
                                $(this).spinner("value", max);
                            }
                            else if ((value % 0.5) != 0)
                            {
                                $(this).spinner("value", value - (value % 0.5));
                            }
                        }
                    };

                    item.css({overflow: "hidden", whiteSpace: "nowrap"});

                    const row = $("<div/>").appendTo(item);

                    const speakerTarget = $("<select/>", {class: "node-input-speakerTarget", style: "width: auto;"})
                            .append($("<option></option>").val("inCeilingSpeakerMode").text(node._("control.list.speakerTarget.inCeilingSpeakerMode")))
                            .append($("<option></option>").val("speakerSelection").text(node._("control.list.speakerTarget.speakerSelection")))
                            .append($("<option></option>").val("frontLLevel").text(node._("control.list.speakerTarget.frontLLevel")))
                            .append($("<option></option>").val("frontRLevel").text(node._("control.list.speakerTarget.frontRLevel")))
                            .append($("<option></option>").val("centerLevel").text(node._("control.list.speakerTarget.centerLevel")))
                            .append($("<option></option>").val("surroundLLevel").text(node._("control.list.speakerTarget.surroundLLevel")))
                            .append($("<option></option>").val("surroundRLevel").text(node._("control.list.speakerTarget.surroundRLevel")))
                            .append($("<option></option>").val("surroundcBackLevel").text(node._("control.list.speakerTarget.surroundcBackLevel")))
                            .append($("<option></option>").val("surroundBackLLevel").text(node._("control.list.speakerTarget.surroundBackLLevel")))
                            .append($("<option></option>").val("surroundBackRLevel").text(node._("control.list.speakerTarget.surroundBackRLevel")))
                            .append($("<option></option>").val("heightLLevel").text(node._("control.list.speakerTarget.heightLLevel")))
                            .append($("<option></option>").val("heightRLevel").text(node._("control.list.speakerTarget.heightRLevel")))
                            .append($("<option></option>").val("subwooferLevel").text(node._("control.list.speakerTarget.subwooferLevel")))
                            .appendTo(row);

                    $("<div/>", {style: "display:inline-block; padding: 0px 6px;"})
                        .text('=')
                        .appendTo(row);

                    const inCeilingSpeakerMode = $("<select/>", {class: "node-input-inCeilingSpeakerMode", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.inCeilingSpeakerMode.off")))
                            .append($("<option></option>").val("front").text(node._("control.list.inCeilingSpeakerMode.front")))
                            .append($("<option></option>").val("front&center").text(node._("control.list.inCeilingSpeakerMode.front_center")))
                            .appendTo(row);

                    const speakerSelection = $("<select/>", {class: "node-input-speakerSelection", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.speakerSelection.off")))
                            .append($("<option></option>").val("speakerA").text(node._("control.list.speakerSelection.speakerA")))
                            .append($("<option></option>").val("speakerB").text(node._("control.list.speakerSelection.speakerB")))
                            .append($("<option></option>").val("speakerA_B").text(node._("control.list.speakerSelection.speakerA_B")))
                            .appendTo(row);

                    const speakerLevel = $("<input/>", {class: "node-input-speakerLevel", style: "width: 50px !important;"})
                            .appendTo(row)
                            .spinner(speakerLevelSpinner)
                            .spinner("value", 0);

                    speakerTarget.change(function()
                    {
                        value = speakerTarget.val();

                        inCeilingSpeakerMode.hide();
                        speakerSelection.hide();
                        speakerLevel.parent().hide();

                        if (value == "inCeilingSpeakerMode")
                        {
                            inCeilingSpeakerMode.show();
                        }
                        else if (value == "speakerSelection")
                        {
                            speakerSelection.show();
                        }
                        else
                        {
                            speakerLevel.parent().show();
                        }
                    });

                    if (speakerSetting.target == "inCeilingSpeakerMode")
                    {
                        inCeilingSpeakerMode.val(speakerSetting.value);
                    }
                    else if (speakerSetting.target == "speakerSelection")
                    {
                        speakerSelection.val(speakerSetting.value);
                    }
                    else
                    {
                        speakerLevel.spinner("value", speakerSetting.value);
                    }

                    speakerTarget.val(speakerSetting.target);
                    speakerTarget.change();
                }
            });

            const modeSettingsList = $("#node-input-modeSettingsList").css("min-height", "200px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, modeSetting)
                {
                    if (!("target" in modeSetting))
                    {
                        modeSetting.target = "playType";
                        modeSetting.value = "normal";
                    }

                    item.css({overflow: "hidden", whiteSpace: "nowrap"});

                    const row = $("<div/>").appendTo(item);

                    const modeTarget = $("<select/>", {class: "node-input-modeTarget", style: "width: auto;"})
                            .append($("<option></option>").val("playType").text(node._("control.list.modeTarget.playType")))
                            .append($("<option></option>").val("repeatType").text(node._("control.list.modeTarget.repeatType")))
                            .append($("<option></option>").val("shuffleType").text(node._("control.list.modeTarget.shuffleType")))
                            .append($("<option></option>").val("autoPlayback").text(node._("control.list.modeTarget.autoPlayback")))
                            .appendTo(row);

                    $("<div/>", {style: "display:inline-block; padding: 0px 6px;"})
                        .text('=')
                        .appendTo(row);

                    const playType = $("<select/>", {class: "node-input-playType", style: "width: auto;"})
                            .append($("<option></option>").val("normal").text(node._("control.list.playType.normal")))
                            .append($("<option></option>").val("repeatAll").text(node._("control.list.playType.repeatAll")))
                            .append($("<option></option>").val("repeatFolder").text(node._("control.list.playType.repeatFolder")))
                            .append($("<option></option>").val("repeatTrack").text(node._("control.list.playType.repeatTrack")))
                            .append($("<option></option>").val("shuffleAll").text(node._("control.list.playType.shuffleAll")))
                            .appendTo(row);

                    const repeatType = $("<select/>", {class: "node-input-repeatType", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.repeatType.off")))
                            .append($("<option></option>").val("all").text(node._("control.list.repeatType.all")))
                            .append($("<option></option>").val("folder").text(node._("control.list.repeatType.folder")))
                            .append($("<option></option>").val("track").text(node._("control.list.repeatType.track")))
                            .append($("<option></option>").val("chapter").text(node._("control.list.repeatType.chapter")))
                            .appendTo(row);

                    const shuffleType = $("<select/>", {class: "node-input-shuffleType", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.shuffleType.off")))
                            .append($("<option></option>").val("folder").text(node._("control.list.shuffleType.folder")))
                            .appendTo(row);

                    const autoPlayback = $("<select/>", {class: "node-input-autoPlayback", style: "width: auto;"})
                            .append($("<option></option>").val("off").text(node._("control.list.switch.off")))
                            .append($("<option></option>").val("on").text(node._("control.list.switch.on")))
                            .appendTo(row);

                    modeTarget.change(function()
                    {
                        value = modeTarget.val();

                        playType.hide();
                        repeatType.hide();
                        shuffleType.hide();
                        autoPlayback.hide();

                        if (value == "playType")
                        {
                            playType.show();
                        }
                        else if (value == "repeatType")
                        {
                            repeatType.show();
                        }
                        else if (value == "shuffleType")
                        {
                            shuffleType.show();
                        }
                        else if (value == "autoPlayback")
                        {
                            autoPlayback.show();
                        }
                    });

                    if (modeSetting.target == "playType")
                    {
                        playType.val(modeSetting.value);
                    }
                    else if (modeSetting.target == "repeatType")
                    {
                        repeatType.val(modeSetting.value);
                    }
                    else if (modeSetting.target == "shuffleType")
                    {
                        shuffleType.val(modeSetting.value);
                    }
                    else if (modeSetting.target == "autoPlayback")
                    {
                        autoPlayback.val(modeSetting.value);
                    }

                    modeTarget.val(modeSetting.target);
                    modeTarget.change();
                }
            });

            const propertyList = $("#node-input-propertyList").css("min-height", "200px").css("min-width", "550px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, prop)
                {
                    if (!("type" in prop))
                    {
                        prop = {type: "msg", name: "", value: {type: "str", content: ""}};
                    }

                    item.css({overflow: "hidden", whiteSpace: "nowrap"});

                    const row = $("<div/>").appendTo(item);

                    const propertyName = $("<input/>", {class: "node-input-propertName", type: "text"})
                                            .css("width", "40%")
                                            .appendTo(row)
                                            .typedInput({default: prop.type || "msg", types: ["global", "flow", "msg"]});

                    $("<div/>", {style: "display:inline-block; padding: 0px 6px;"})
                        .text('=')
                        .appendTo(row);

                    const propertyValue = $("<input/>", {class: "node-input-propertyValue", type: "text"})
                                            .css("width", "calc(60% - 30px)")
                                            .appendTo(row)
                                            .typedInput({default: prop.value.type || "str", types:[filteredDataType, unfilteredDataType, "env", "str", "num", "bool", "json", "jsonata", "bin", "date"]});

                    propertyName.typedInput("value", prop.name);
                    propertyValue.typedInput("value", prop.value.content);
                }
            });

            relativeVol.change(function()
            {
                if ($(this).prop("checked"))
                {
                    volSpinner.spinner("option", "min", "-10");
                    volSpinner.spinner("option", "max", "10");
                }
                else
                {
                    volSpinner.spinner("option", "min", "0");
                    volSpinner.spinner("option", "max", "99");
                }
            });

            allZones.change(function()
            {
                if ($(this).prop("checked"))
                {
                    zoneSpinner.spinner("disable");
                    zoneSpinner.spinner("option", "min", "0");
                    zoneSpinner.spinner("value", 0);
                }
                else
                {
                    zoneSpinner.spinner("enable");
                    zoneSpinner.spinner("value", 1);
                    zoneSpinner.spinner("option", "min", "1");
                }
            });

            action.on("change", function()
            {
                $("#form-row-swupdate").hide();
                $("#form-row-volume").hide();
                $("#form-row-source").hide();
                $("#form-row-zone").hide();
                $("#form-row-port").hide();
                $("#form-row-preset").hide();
                $("#form-row-soundSettings").hide();
                $("#form-row-soundTarget").hide();
                $("#form-row-speakerSettings").hide();
                $("#form-row-speakerTarget").hide();
                $("#form-row-modeSettings").hide();
                $("#form-row-modeTarget").hide();
                $("#form-row-api").hide();
                $("#form-row-params").hide();

                const type = action.typedInput("type");
                const value = action.typedInput("value");

                if (type == "control")
                {
                    switch (value)
                    {
                        case "setSource":
                        {
                            $("#form-row-source").show();
                            $("#form-row-zone").show();

                            if ((sourceSelect.val() == "extInput:hdmi") ||
                                (sourceSelect.val() == "extInput:line"))
                            {
                                $("#form-row-port").show();
                            }
                            else if (sourceSelect.val() == "radio:fm")
                            {
                                $("#form-row-preset").show();
                            }

                            break;
                        }
                        case "setVolume":
                        {
                            $("#form-row-volume").show();
                            $("#form-row-zone").show();

                            break;
                        }
                        case "mute":
                        case "unmute":
                        case "toggleMute":
                        case "stop":
                        case "togglePause":
                        case "skipPrev":
                        case "skipNext":
                        case "scanForward":
                        case "scanBackward":
                        {
                            $("#form-row-zone").show();
                            break;
                        }
                        case "setSoundSettings":
                        {
                            $("#form-row-soundSettings").show();
                            break;
                        }
                        case "setSpeakerSettings":
                        {
                            $("#form-row-speakerSettings").show();
                            break;
                        }
                        case "setPlaybackSettings":
                        {
                            $("#form-row-modeSettings").show();
                            break;
                        }
                    }
                }
                else if (type == "retrieve")
                {
                    switch (value)
                    {
                        case "getSWUpdateInfo":
                        {
                            $("#form-row-swupdate").show();
                            break;
                        }
                        case "getSource":
                        case "getVolumeInfo":
                        {
                            $("#form-row-zone").show();
                            break;
                        }
                        case "getSoundSettings":
                        {
                            $("#form-row-soundTarget").show();
                            break;
                        }
                        case "getSpeakerSettings":
                        {
                            $("#form-row-speakerTarget").show();
                            break;
                        }
                        case "getPlaybackSettings":
                        {
                            $("#form-row-modeTarget").show();
                            break;
                        }
                    }
                }
                else if (type == "api")
                {
                    $("#form-row-api").show();
                    $("#form-row-params").show();
                }

                resizeEdit({height: $(".red-ui-tray-content form").height()});
            });

            sourceSelect.change(function()
            {
                if ((action.typedInput("type") == "control") && (action.typedInput("value") == "setSource"))
                {
                    if (($(this).val() == "extInput:hdmi") ||
                        ($(this).val() == "extInput:line"))
                    {
                        $("#form-row-port").show();
                    }
                    else
                    {
                        $("#form-row-port").hide();
                    }

                    if ($(this).val() == "radio:fm")
                    {
                        $("#form-row-preset").show();
                    }
                    else
                    {
                        $("#form-row-preset").hide();
                    }

                    resizeEdit({height: $(".red-ui-tray-content form").height()});
                }
            });

            if (node.zone == 0)
            {
                allZones.prop("checked", true);
                zoneSpinner.spinner("disable");
                zoneSpinner.spinner("option", "min", "0");
            }

            node.soundSettings.forEach(setting =>
            {
                soundSettingsList.editableList("addItem", setting);
            });

            node.speakerSettings.forEach(setting =>
            {
                speakerSettingsList.editableList("addItem", setting);
            });

            node.modeSettings.forEach(setting =>
            {
                modeSettingsList.editableList("addItem", setting);
            });

            node.outputProperties.forEach(prop =>
            {
                propertyList.editableList("addItem", prop);
            });
        },
        oneditsave: function()
        {
            const node = this;

            node.soundSettings = [];
            $("#node-input-soundSettingsList").editableList("items").each(function(index)
            {
                const setting = {target: $(this).find(".node-input-soundTarget").val()};
                if (setting.target == "soundField")
                {
                    setting.value = $(this).find(".node-input-soundField").val();
                }
                else if (setting.target == "footballMode")
                {
                    setting.value = $(this).find(".node-input-footballMode").val();
                }
                else if (setting.target == "voice")
                {
                    setting.value = $(this).find(".node-input-voiceType").val();
                }
                else
                {
                    setting.value = $(this).find(".node-input-switchedOn").prop("checked") ? "on" : "off";
                }

                node.soundSettings.push(setting);
            });

            node.speakerSettings = [];
            $("#node-input-speakerSettingsList").editableList("items").each(function(index)
            {
                const setting = {target: $(this).find(".node-input-speakerTarget").val()};
                if (setting.target == "inCeilingSpeakerMode")
                {
                    setting.value = $(this).find(".node-input-inCeilingSpeakerMode").val();
                }
                else if (setting.target == "speakerSelection")
                {
                    setting.value = $(this).find(".node-input-speakerSelection").val();
                }
                else
                {
                    setting.value = $(this).find(".node-input-speakerLevel").spinner("value");
                }

                node.speakerSettings.push(setting);
            });

            node.modeSettings = [];
            $("#node-input-modeSettingsList").editableList("items").each(function(index)
            {
                const setting = {target: $(this).find(".node-input-modeTarget").val()};
                if (setting.target == "playType")
                {
                    setting.value = $(this).find(".node-input-playType").val();
                }
                else if (setting.target == "repeatType")
                {
                    setting.value = $(this).find(".node-input-repeatType").val();
                }
                else if (setting.target == "shuffleType")
                {
                    setting.value = $(this).find(".node-input-shuffleType").val();
                }
                else if (setting.target == "autoPlayback")
                {
                    setting.value = $(this).find(".node-input-autoPlayback").val();
                }

                node.modeSettings.push(setting);
            });

            node.outputProperties = [];
            node.outputs = $("#node-input-msgPassThrough").prop("checked") ? 1 : 0;

            $("#node-input-propertyList").editableList("items").each(function(index)
            {
                const propertyName = $(this).find(".node-input-propertName");
                const propertyValue = $(this).find(".node-input-propertyValue");

                node.outputProperties.push({type: propertyName.typedInput("type"),
                                            name: propertyName.typedInput("value"),
                                            value: {type: propertyValue.typedInput("type"),
                                                    content: propertyValue.typedInput("value")}});

                if (propertyName.typedInput("type") == "msg")
                {
                    node.outputs = 1;
                }
            });
        },
        oneditresize: resizeEdit
    });
</script>
